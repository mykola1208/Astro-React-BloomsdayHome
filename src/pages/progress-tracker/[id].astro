---
import Layout from "../../layouts/Layout.astro";
import Accordion from "../../components/Accordion.astro";
import Task from "../../components/Task.astro";
import ActivityFeed from "../../components/ActivityFeed.astro";
import { trackerAccordionItems, requestParamIds } from "../../data/data.js";
import ShowAddress from "../../components/ShowAddress.astro";
import { getTasks } from "../api/getTasks";

const graphqlEndpoint = import.meta.env.PUBLIC_HASURA_BASE_URL;
const token = await Astro.locals.auth().getToken({ template: "hasura" });
const { id } = Astro.params;

const [tasks, incompleteTasksCount] = await getTasks(graphqlEndpoint, token, id);
---

<Layout title="Bloomsday">
  <div class="relative dropdown">
    <div class="py-3 px-6 flex gap-7 flex-col">
      <div class="neue text-darkgreen text-lg font-bold leading-5">
        <ShowAddress
          breadcrumbs={[
            { title: "Home", url: "#" },
            { title: "Progress Tracker", url: "#" },
          ]}
        />
        <div class="flex flex-row py-8 px-6 border border-sage rounded-md">
          <div class="basis-1/4">
            <Accordion items={trackerAccordionItems} />
          </div>
          <div class="flex flex-col basis-3/4 pl-9">
            <p class="text-lg text-darkgreen font-medium">
              {tasks[requestParamIds[id]]?.description}
            </p>
            {
              (tasks[requestParamIds[id]]?.tasks != undefined &&  incompleteTasksCount > 0) && (
                <div class="flex justify-between items-center content-center">
                  <p class="text-lg not-italic font-medium leading-6">
                    You have{" "}
                    <span class="font-bold">{incompleteTasksCount} tasks</span>{" "}
                    to complete.
                  </p>
                </div>
              )
            }
            <div class="flex grow gap-3.5 mt-5">
              {
                tasks[requestParamIds[id]]?.tasks != undefined &&
                  tasks[requestParamIds[id]].tasks.map(
                    ({ headerIcon, header, checkList }) => (
                      <div class="basis-1/4">
                        <Task
                          headerIcon={headerIcon}
                          header={header}
                          checkList={checkList}
                        />
                      </div>
                    )
                  )
              }
            </div>
          </div>
        </div>
      </div>
    </div>
    <ActivityFeed />
  </div>
</Layout>
